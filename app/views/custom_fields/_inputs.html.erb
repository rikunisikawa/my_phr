<% sanitized_prefix = form_prefix.to_s.gsub(/[^a-zA-Z0-9]+/, "_") %>
<% boolean_type = ApplicationHelper::BOOLEAN_TYPE %>
<div class="row g-3">
  <% fields.each do |field| %>
    <% input_name = "#{form_prefix}[custom_field_values][#{field.id}]" %>
    <% input_id = "#{sanitized_prefix}_custom_field_#{field.id}" %>
    <% value_map = values.is_a?(Hash) ? values : {} %>
    <% current_value = value_map[field.name] %>
    <% enabled = if field.field_type == "boolean" %>
                   !current_value.nil?
                 else
                   current_value.present?
                 end %>
    <div class="col-md-6" data-custom-field data-custom-field-type="<%= field.field_type %>">
      <div class="border rounded p-3 h-100">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label class="form-label mb-0" for="<%= input_id %>"><%= field.name %></label>
          <div class="form-check form-switch m-0">
            <input type="checkbox"
                   class="form-check-input"
                   role="switch"
                   id="<%= input_id %>_toggle"
                   data-custom-field-toggle
                   <%= "checked" if enabled %>>
            <label class="form-check-label small text-muted" for="<%= input_id %>_toggle">入力する</label>
          </div>
        </div>
        <%= hidden_field_tag input_name,
                               "",
                               id: nil,
                               data: { custom_field_reset: true },
                               disabled: (enabled || field.field_type == "boolean") ? true : nil %>
        <div class="<%= enabled ? "" : "d-none" %>" data-custom-field-body>
          <% case field.field_type %>
          <% when "boolean" %>
            <%= hidden_field_tag input_name, "0", id: nil, data: { custom_field_element: true }, disabled: (enabled ? nil : true) %>
            <div class="form-check form-switch">
              <%= check_box_tag input_name,
                                 "1",
                                 boolean_type.cast(current_value),
                                 class: "form-check-input",
                                 id: input_id,
                                 data: { custom_field_element: true },
                                 disabled: (enabled ? nil : true) %>
              <label class="form-check-label" for="<%= input_id %>">はい</label>
            </div>
          <% when "number" %>
            <%= number_field_tag input_name,
                                 current_value,
                                 class: "form-control",
                                 id: input_id,
                                 step: "any",
                                 data: { custom_field_element: true },
                                 disabled: (enabled ? nil : true) %>
          <% when "select" %>
            <%= select_tag input_name,
                           options_for_select(field.options || [], current_value),
                           include_blank: "選択してください",
                           class: "form-select",
                           id: input_id,
                           data: { custom_field_element: true },
                           disabled: (enabled ? nil : true) %>
            <% if field.options.present? %>
              <div class="form-text">選択肢: <%= field.options.join(" / ") %></div>
            <% end %>
          <% else %>
            <%= text_field_tag input_name,
                               current_value,
                               class: "form-control",
                               id: input_id,
                               data: { custom_field_element: true },
                               disabled: (enabled ? nil : true) %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>
