<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">カスタム項目の設定</h1>
  <%= link_to "基本情報に戻る", profile_path, class: "btn btn-outline-secondary btn-sm" %>
</div>

<p class="text-muted">プロフィール・健康ログ・運動ログごとに任意のカスタム項目を追加できます。追加した項目は各入力フォームで利用できます。</p>

<div class="d-grid gap-4">
  <% CustomField::CATEGORIES.each do |category| %>
    <% fields = @grouped_fields[category] || [] %>
    <% form_object = @form_objects[category] %>
    <% options_value = @options_text_values[category] %>
    <% if options_value.blank? && form_object.field_type == "select" && form_object.options.present? %>
      <% options_value = form_object.options.join("\n") %>
    <% end %>
    <div class="card shadow-sm" id="<%= category %>">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0"><%= custom_field_category_label(category) %>のカスタム項目</h2>
      </div>
      <div class="card-body">
        <h3 class="h6">登録済み項目</h3>
        <% if fields.any? %>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th scope="col">項目名</th>
                  <th scope="col">入力形式</th>
                  <th scope="col">選択肢</th>
                  <th scope="col" class="text-end">操作</th>
                </tr>
              </thead>
              <tbody>
                <% fields.each do |field| %>
                  <tr>
                    <td><%= field.name %></td>
                    <td><%= custom_field_type_label(field.field_type) %></td>
                    <td>
                      <% if field.field_type == "select" && field.options.present? %>
                        <span class="small"><%= field.options.join(" / ") %></span>
                      <% else %>
                        <span class="text-muted small">-</span>
                      <% end %>
                    </td>
                    <td class="text-end">
                      <%= button_to "削除", custom_field_path(field), method: :delete, class: "btn btn-outline-danger btn-sm", data: { turbo_confirm: "この項目を削除しますか？" } %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p class="text-muted">まだカスタム項目は登録されていません。</p>
        <% end %>

        <hr class="my-4">

        <h3 class="h6">新規追加</h3>
        <%= form_with model: form_object, url: custom_fields_path, local: true, html: { class: "row g-3" }, data: { custom_field_form: true } do |f| %>
          <%= f.hidden_field :category, value: category %>
          <div class="col-md-5">
            <%= f.label :name, "項目名", class: "form-label" %>
            <%= f.text_field :name, class: "form-control", required: true %>
            <% if form_object.errors[:name].any? %>
              <div class="invalid-feedback d-block"><%= form_object.errors[:name].join(", ") %></div>
            <% end %>
          </div>
          <div class="col-md-4">
            <%= f.label :field_type, "入力形式", class: "form-label" %>
            <%= f.select :field_type,
                         options_for_select(CustomField::FIELD_TYPES.map { |type| [custom_field_type_label(type), type] }, form_object.field_type),
                         {},
                         class: "form-select",
                         data: { field_type: true } %>
            <% if form_object.errors[:field_type].any? %>
              <div class="invalid-feedback d-block"><%= form_object.errors[:field_type].join(", ") %></div>
            <% end %>
          </div>
          <% options_group_classes = ["col-md-12"] %>
          <% options_group_classes << "d-none" unless form_object.field_type == "select" %>
          <div class="<%= options_group_classes.join(' ') %>" data-options-group>
            <label class="form-label" for="options_<%= category %>">選択肢 (1 行につき 1 件)</label>
            <%= text_area_tag "custom_field[options_text]",
                              options_value,
                              class: "form-control",
                              rows: 3,
                              id: "options_#{category}",
                              data: { options_input: true },
                              disabled: form_object.field_type != "select" %>
            <% if form_object.errors[:options].any? %>
              <div class="invalid-feedback d-block"><%= form_object.errors[:options].join(", ") %></div>
            <% end %>
          </div>
          <div class="col-md-3">
            <%= f.submit "追加する", class: "btn btn-primary" %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
