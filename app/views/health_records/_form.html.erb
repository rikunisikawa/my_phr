<%= form_with model: @health_record,
              url: @health_record.persisted? ? health_record_path(@health_record) : health_records_path,
              method: @health_record.persisted? ? :patch : :post,
              local: true do |f| %>
  <div class="row g-3">
    <div class="col-md-4">
      <%= f.label :logged_on, "記録日", class: "form-label" %>
      <%= f.date_field :logged_on, class: "form-control" %>
    </div>
    <div class="col-md-8 d-flex gap-3 flex-wrap">
      <% score_options = (1..5).map { |value| [value, value] } %>
      <div class="flex-grow-1">
        <%= f.label :mood, "気分(1-5)", class: "form-label" %>
        <%= f.select :mood, options_for_select(score_options, @health_record.mood), { include_blank: "選択してください" }, class: "form-select" %>
      </div>
      <div class="flex-grow-1">
        <%= f.label :stress_level, "ストレス(1-5)", class: "form-label" %>
        <%= f.select :stress_level, options_for_select(score_options, @health_record.stress_level), { include_blank: "選択してください" }, class: "form-select" %>
      </div>
      <div class="flex-grow-1">
        <%= f.label :fatigue_level, "疲労感(1-5)", class: "form-label" %>
        <%= f.select :fatigue_level, options_for_select(score_options, @health_record.fatigue_level), { include_blank: "選択してください" }, class: "form-select" %>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <%= f.label :notes, "メモ", class: "form-label" %>
    <%= f.text_area :notes, class: "form-control", rows: 3 %>
  </div>

  <div class="mt-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 class="h6 mb-0">健康カスタム項目</h3>
      <% if @health_custom_fields.any? %>
        <%= link_to "設定を編集", custom_fields_path(anchor: "health"), class: "btn btn-outline-secondary btn-sm" %>
      <% end %>
    </div>
    <% if @health_custom_fields.any? %>
      <%= render "custom_fields/inputs",
                 fields: @health_custom_fields,
                 values: @health_record.custom_fields || {},
                 form_prefix: "health_log" %>
    <% else %>
      <p class="text-muted small mb-2">健康ログにカスタム項目は設定されていません。</p>
      <%= link_to "カスタム項目を設定する", custom_fields_path(anchor: "health"), class: "btn btn-outline-secondary btn-sm" %>
    <% end %>
  </div>

  <div class="mt-4">
    <h3 class="h6">運動記録</h3>
    <p class="small text-muted">最大3件まで入力できます。不要な行は削除してください。</p>
    <% if @activity_custom_fields.any? %>
      <div class="text-end mb-2">
        <%= link_to "カスタム項目を編集", custom_fields_path(anchor: "activity"), class: "btn btn-outline-secondary btn-sm" %>
      </div>
    <% end %>
    <div class="d-grid gap-3">
      <%= f.fields_for :activity_logs do |activity_form| %>
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <%= activity_form.label :activity_type, "種目", class: "form-label" %>
                <%= activity_form.text_field :activity_type, class: "form-control" %>
              </div>
              <div class="col-md-4">
                <%= activity_form.label :duration_minutes, "時間(分)", class: "form-label" %>
                <%= activity_form.number_field :duration_minutes, class: "form-control", min: 0 %>
              </div>
              <div class="col-md-4">
                <%= activity_form.label :intensity, "強度", class: "form-label" %>
                <%= activity_form.select :intensity, options_for_select([["低い", "low"], ["中程度", "moderate"], ["高い", "high"]], activity_form.object.intensity), { include_blank: "選択してください" }, class: "form-select" %>
              </div>
            </div>

            <div class="mt-3">
              <h4 class="h6">運動カスタム項目</h4>
              <% if @activity_custom_fields.any? %>
                <%= render "custom_fields/inputs",
                           fields: @activity_custom_fields,
                           values: activity_form.object.custom_fields || {},
                           form_prefix: activity_form.object_name %>
              <% else %>
                <p class="text-muted small mb-1">運動のカスタム項目は設定されていません。</p>
                <%= link_to "カスタム項目を設定する", custom_fields_path(anchor: "activity"), class: "btn btn-outline-secondary btn-sm" %>
              <% end %>
            </div>

            <% if activity_form.object.persisted? %>
              <div class="form-check mt-3">
                <%= activity_form.check_box :_destroy, class: "form-check-input", id: "#{activity_form.object_name.parameterize}_destroy" %>
                <%= activity_form.label :_destroy, "この運動記録を削除", class: "form-check-label", for: "#{activity_form.object_name.parameterize}_destroy" %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="mt-4 d-flex gap-2">
    <%= f.submit "保存する", class: "btn btn-primary" %>
    <%= link_to "一覧に戻る", health_records_path, class: "btn btn-outline-secondary" %>
  </div>
<% end %>
