<%= form_with model: @health_record,
              url: @health_record.persisted? ? health_record_path(@health_record) : health_records_path,
              method: @health_record.persisted? ? :patch : :post,
              local: true do |f| %>
  <div class="row g-3">
    <div class="col-md-4">
      <%= f.label :recorded_at, "記録日時", class: "form-label" %>
      <%= f.datetime_field :recorded_at, class: "form-control", step: 60 %>
    </div>
    <div class="col-md-8 d-flex gap-3 flex-wrap" data-health-sliders>
      <% mood_value = @health_record.mood.nil? ? 50 : @health_record.mood %>
      <div class="flex-grow-1" data-health-slider>
        <div class="d-flex justify-content-between align-items-center mb-1">
          <%= f.label :mood, "気分(0-100)", class: "form-label mb-0" %>
          <span class="badge text-bg-light" data-health-slider-value><%= mood_value %></span>
        </div>
        <%= f.range_field :mood,
                          class: "form-range",
                          min: 0,
                          max: 100,
                          step: 1,
                          value: mood_value,
                          data: { health_slider_input: true } %>
      </div>
      <% stress_value = @health_record.stress_level.nil? ? 50 : @health_record.stress_level %>
      <div class="flex-grow-1" data-health-slider>
        <div class="d-flex justify-content-between align-items-center mb-1">
          <%= f.label :stress_level, "ストレス(0-100)", class: "form-label mb-0" %>
          <span class="badge text-bg-light" data-health-slider-value><%= stress_value %></span>
        </div>
        <%= f.range_field :stress_level,
                          class: "form-range",
                          min: 0,
                          max: 100,
                          step: 1,
                          value: stress_value,
                          data: { health_slider_input: true } %>
      </div>
      <% fatigue_value = @health_record.fatigue_level.nil? ? 50 : @health_record.fatigue_level %>
      <div class="flex-grow-1" data-health-slider>
        <div class="d-flex justify-content-between align-items-center mb-1">
          <%= f.label :fatigue_level, "疲労感(0-100)", class: "form-label mb-0" %>
          <span class="badge text-bg-light" data-health-slider-value><%= fatigue_value %></span>
        </div>
        <%= f.range_field :fatigue_level,
                          class: "form-range",
                          min: 0,
                          max: 100,
                          step: 1,
                          value: fatigue_value,
                          data: { health_slider_input: true } %>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <%= f.label :notes, "メモ", class: "form-label" %>
    <%= f.text_area :notes, class: "form-control", rows: 3 %>
  </div>

  <div class="mt-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 class="h6 mb-0">健康カスタム項目</h3>
      <% if @health_custom_fields.any? %>
        <%= link_to "設定を編集", custom_fields_path(anchor: "health"), class: "btn btn-outline-secondary btn-sm" %>
      <% end %>
    </div>
    <% if @health_custom_fields.any? %>
      <%= render "custom_fields/inputs",
                 fields: @health_custom_fields,
                 values: @health_record.custom_fields || {},
                 form_prefix: "health_log" %>
    <% else %>
      <p class="text-muted small mb-2">健康ログにカスタム項目は設定されていません。</p>
      <%= link_to "カスタム項目を設定する", custom_fields_path(anchor: "health"), class: "btn btn-outline-secondary btn-sm" %>
    <% end %>
  </div>

  <div class="mt-4" data-activity-logs-container data-activity-logs-persist="<%= @health_record.persisted? ? "false" : "true" %>">
    <div class="d-flex align-items-center justify-content-between">
      <h3 class="h6 mb-0">運動記録</h3>
      <button type="button" class="btn btn-outline-primary btn-sm" data-activity-logs-add-button>運動記録を追加</button>
    </div>
    <p class="small text-muted mt-2 mb-0">必要な分だけ追加してください。不要な行は削除できます。</p>
    <div class="d-grid gap-3 mt-3" data-activity-logs-list>
      <%= f.fields_for :activity_logs do |activity_form| %>
        <% custom_fields_value = if activity_form.object.custom_fields.present?
                                    JSON.pretty_generate(activity_form.object.custom_fields)
                                  else
                                    "{}"
                                  end %>
        <div class="card shadow-sm" data-activity-logs-item data-activity-log-uuid="<%= activity_form.object.id || activity_form.index %>">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <%= activity_form.label :activity_type, "種目", class: "form-label" %>
                <%= activity_form.text_field :activity_type, class: "form-control" %>
              </div>
              <div class="col-md-4">
                <%= activity_form.label :duration_minutes, "時間(分)", class: "form-label" %>
                <%= activity_form.number_field :duration_minutes, class: "form-control", min: 0 %>
              </div>
              <div class="col-md-4">
                <%= activity_form.label :intensity, "強度", class: "form-label" %>
                <%= activity_form.select :intensity, options_for_select([["低い", "low"], ["中程度", "moderate"], ["高い", "high"]], activity_form.object.intensity), { include_blank: "選択してください" }, class: "form-select" %>
              </div>
            </div>

            <div class="mt-3">
              <h4 class="h6">運動カスタム項目</h4>
              <% if @activity_custom_fields.any? %>
                <%= render "custom_fields/inputs",
                           fields: @activity_custom_fields,
                           values: activity_form.object.custom_fields || {},
                           form_prefix: activity_form.object_name %>
              <% else %>
                <p class="text-muted small mb-1">運動のカスタム項目は設定されていません。</p>
                <%= link_to "カスタム項目を設定する", custom_fields_path(anchor: "activity"), class: "btn btn-outline-secondary btn-sm" %>
              <% end %>
            </div>

            <% if activity_form.object.persisted? %>
              <div class="form-check mt-3">
                <%= activity_form.check_box :_destroy, class: "form-check-input", id: "#{activity_form.object_name.parameterize}_destroy" %>
                <%= activity_form.label :_destroy, "この運動記録を削除", class: "form-check-label", for: "#{activity_form.object_name.parameterize}_destroy" %>
              </div>
            <% else %>
              <div class="mt-3">
                <button type="button" class="btn btn-outline-danger btn-sm" data-activity-logs-remove>この運動記録を削除</button>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <template data-activity-logs-template>
      <%= f.fields_for :activity_logs, @health_record.activity_logs.build, child_index: "NEW_RECORD" do |activity_form| %>
        <div class="card shadow-sm" data-activity-logs-item data-activity-log-uuid="NEW_RECORD">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <%= activity_form.label :activity_type, "種目", class: "form-label" %>
                <%= activity_form.text_field :activity_type, class: "form-control" %>
              </div>
              <div class="col-md-4">
                <%= activity_form.label :duration_minutes, "時間(分)", class: "form-label" %>
                <%= activity_form.number_field :duration_minutes, class: "form-control", min: 0 %>
              </div>
              <div class="col-md-4">
                <%= activity_form.label :intensity, "強度", class: "form-label" %>
                <%= activity_form.select :intensity, options_for_select([["低い", "low"], ["中程度", "moderate"], ["高い", "high"]], activity_form.object.intensity), { include_blank: "選択してください" }, class: "form-select" %>
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label">運動カスタム項目(JSON)</label>
              <%= text_area_tag "#{activity_form.object_name}[custom_fields_raw]", "{}", class: "form-control", rows: 3 %>
            </div>

            <div class="mt-3">
              <button type="button" class="btn btn-outline-danger btn-sm" data-activity-logs-remove>この運動記録を削除</button>
            </div>
          </div>
        </div>
      <% end %>
    </template>
  </div>

  <div class="mt-4 d-flex gap-2">
    <%= f.submit "保存する", class: "btn btn-primary" %>
    <%= link_to "一覧に戻る", health_records_path, class: "btn btn-outline-secondary" %>
  </div>
<% end %>
