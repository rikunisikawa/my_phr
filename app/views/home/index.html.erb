<div class="row g-3 align-items-center mb-4">
  <div class="col-md-8">
    <h1 class="h3 mb-2 d-flex align-items-center gap-2">
      <span class="material-symbols-outlined text-primary" aria-hidden="true">space_dashboard</span>
      <span>ダッシュボード</span>
    </h1>
    <p class="text-muted mb-0">最新の健康状態と週次サマリーを確認できます。</p>
  </div>
  <div class="col-md-4 text-md-end">
    <%= link_to new_health_record_path, class: "btn btn-primary d-inline-flex align-items-center gap-2" do %>
      <span class="material-symbols-outlined" aria-hidden="true">add_circle</span>
      <span>健康ログを登録</span>
    <% end %>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <h2 class="h6 mb-0 d-flex align-items-center gap-2">
          <span class="material-symbols-outlined text-primary" aria-hidden="true">ecg_heart</span>
          <span>環境センサーデータ</span>
        </h2>
        <% if @environmental_source_file.present? %>
          <span class="badge bg-light text-muted">最新ファイル: <%= @environmental_source_file.basename %></span>
        <% end %>
      </div>
      <div class="card-body">
        <% if @environmental_data_error.present? %>
          <div class="alert alert-warning" role="alert">
            外部データの読み込みに失敗しました: <%= @environmental_data_error %>
          </div>
        <% end %>

        <% if @environmental_samples.present? %>
          <% latest_sample = @environmental_samples.last %>
          <div class="row g-3 align-items-end mb-3">
            <div class="col-md-4">
              <p class="text-muted mb-1">最新の測定</p>
              <p class="h5 mb-0">
                <span class="d-block small text-muted">取得時刻</span>
                <%= l(latest_sample[:timestamp], format: "%Y-%m-%d %H:%M") %>
              </p>
            </div>
            <div class="col-md-8">
              <div class="row g-2 text-center text-md-start">
                <div class="col-4">
                  <div class="border rounded-3 p-3 h-100">
                    <p class="text-muted small mb-1">温度</p>
                    <p class="fs-5 fw-semibold mb-0"><%= latest_sample[:temperature]&.round(1) %>℃</p>
                  </div>
                </div>
                <div class="col-4">
                  <div class="border rounded-3 p-3 h-100">
                    <p class="text-muted small mb-1">湿度</p>
                    <p class="fs-5 fw-semibold mb-0"><%= latest_sample[:humidity]&.round(1) %>%</p>
                  </div>
                </div>
                <div class="col-4">
                  <div class="border rounded-3 p-3 h-100">
                    <p class="text-muted small mb-1">CO₂</p>
                    <p class="fs-5 fw-semibold mb-0"><%= latest_sample[:co2]&.round %>ppm</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="environment-chart"
               class="environment-chart"
               data-chart-data="<%= @environmental_chart_data ? j(@environmental_chart_data.to_json) : nil %>"
               style="min-height: 320px;">
          </div>
        <% else %>
          <p class="text-muted mb-3">
            表示できる外部データがありません。`storage/external_metrics` フォルダに `datetime, Temperature, Humidity, CO2` のヘッダーを持つ CSV ファイルを配置すると、最新ファイルを自動的に読み込みます。
          </p>
          <div id="environment-chart" class="environment-chart" style="min-height: 120px;"></div>
        <% end %>

        <p class="text-muted small mb-0">CSV ファイルはローカルで管理され、アップロードは不要です。最新ファイルがダッシュボードに反映されます。</p>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">
        <h2 class="h6 mb-0 d-flex align-items-center gap-2">
          <span class="material-symbols-outlined text-primary" aria-hidden="true">badge</span>
          <span>プロフィール概要</span>
        </h2>
      </div>
      <div class="card-body">
        <% if @profile.present? && @profile.persisted? %>
          <ul class="list-unstyled mb-0">
            <li class="mb-2 d-flex align-items-center gap-2">
              <span class="material-symbols-outlined text-primary" aria-hidden="true">cake</span>
              <span><span class="text-muted">年齢:</span> <%= @profile.age || "-" %></span>
            </li>
            <li class="mb-2 d-flex align-items-center gap-2">
              <span class="material-symbols-outlined text-primary" aria-hidden="true">straighten</span>
              <span><span class="text-muted">身長:</span> <%= @profile.height_cm ? "#{@profile.height_cm} cm" : "-" %></span>
            </li>
            <li class="d-flex align-items-center gap-2">
              <span class="material-symbols-outlined text-primary" aria-hidden="true">monitor_weight</span>
              <span><span class="text-muted">体重:</span> <%= @profile.weight_kg ? "#{@profile.weight_kg} kg" : "-" %></span>
            </li>
          </ul>
          <div class="mt-3">
            <%= link_to profile_path, class: "btn btn-outline-primary btn-sm d-inline-flex align-items-center gap-2" do %>
              <span class="material-symbols-outlined" aria-hidden="true">open_in_new</span>
              <span>基本情報を見る</span>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted">基本情報が未登録です。</p>
          <%= link_to edit_profile_path, class: "btn btn-outline-primary btn-sm d-inline-flex align-items-center gap-2" do %>
            <span class="material-symbols-outlined" aria-hidden="true">edit</span>
            <span>登録する</span>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">
        <h2 class="h6 mb-0 d-flex align-items-center gap-2">
          <span class="material-symbols-outlined text-primary" aria-hidden="true">monitor_heart</span>
          <span>最新の健康ログ</span>
        </h2>
      </div>
      <div class="card-body">
        <% if @latest_record.present? %>
          <p class="text-muted mb-1"><%= @latest_record.recorded_at ? l(@latest_record.recorded_at, format: "%Y-%m-%d %H:%M") : "日時未設定" %> の記録</p>
          <ul class="list-unstyled mb-3">
            <li class="d-flex align-items-center gap-2 mb-2">
              <span class="material-symbols-outlined text-primary" aria-hidden="true">sentiment_satisfied</span>
              <span>気分: <strong><%= @latest_record.mood || "-" %></strong></span>
            </li>
            <li class="d-flex align-items-center gap-2 mb-2">
              <span class="material-symbols-outlined text-primary" aria-hidden="true">self_improvement</span>
              <span>ストレス: <strong><%= @latest_record.stress_level || "-" %></strong></span>
            </li>
            <li class="d-flex align-items-center gap-2">
              <span class="material-symbols-outlined text-primary" aria-hidden="true">bedtime</span>
              <span>疲労感: <strong><%= @latest_record.fatigue_level || "-" %></strong></span>
            </li>
          </ul>
          <%= link_to health_record_path(@latest_record), class: "btn btn-outline-primary btn-sm d-inline-flex align-items-center gap-2" do %>
            <span class="material-symbols-outlined" aria-hidden="true">visibility</span>
            <span>詳細を見る</span>
          <% end %>
        <% else %>
          <p class="text-muted mb-0">健康ログが登録されていません。</p>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">
        <h2 class="h6 mb-0 d-flex align-items-center gap-2">
          <span class="material-symbols-outlined text-primary" aria-hidden="true">query_stats</span>
          <span>週次サマリー</span>
        </h2>
      </div>
      <div class="card-body">
        <% if @weekly_summary.present? && @weekly_summary.buckets.any? %>
          <% latest_bucket = @weekly_summary.buckets.last %>
          <p class="text-muted mb-2"><%= latest_bucket.label %></p>
          <ul class="list-unstyled mb-3">
            <li class="d-flex align-items-center gap-2 mb-2">
              <span class="material-symbols-outlined text-primary" aria-hidden="true">mood</span>
              <span>平均気分: <strong><%= latest_bucket.averages[:mood]&.round(1) || "-" %></strong></span>
            </li>
            <li class="d-flex align-items-center gap-2 mb-2">
              <span class="material-symbols-outlined text-primary" aria-hidden="true">spa</span>
              <span>平均ストレス: <strong><%= latest_bucket.averages[:stress_level]&.round(1) || "-" %></strong></span>
            </li>
            <li class="d-flex align-items-center gap-2 mb-2">
              <span class="material-symbols-outlined text-primary" aria-hidden="true">bedtime</span>
              <span>平均疲労: <strong><%= latest_bucket.averages[:fatigue_level]&.round(1) || "-" %></strong></span>
            </li>
            <li class="d-flex align-items-center gap-2">
              <span class="material-symbols-outlined text-primary" aria-hidden="true">directions_run</span>
              <span>運動時間合計: <strong><%= latest_bucket.total_activity_duration %> 分</strong></span>
            </li>
          </ul>
          <%= link_to summaries_path(period: "weekly"), class: "btn btn-outline-primary btn-sm d-inline-flex align-items-center gap-2" do %>
            <span class="material-symbols-outlined" aria-hidden="true">analytics</span>
            <span>サマリー詳細</span>
          <% end %>
        <% else %>
          <p class="text-muted mb-0">サマリーを表示できるデータがありません。</p>
        <% end %>
      </div>
    </div>
  </div>
</div>
